from datetime import datetime
from zoneinfo import ZoneInfo

# class system_prompt:
restart = """
解析用戶意圖並決定從哪裡重新規劃行程。

輸入:
1. 用戶訊息 
2. 現有行程列表: [{"step": 1, "name": "地點名稱", "label": "地點類型", "period": "時段"}]
2.1 step從0開始(0為起點)

判斷規則 (依序):
1. 如果用戶直接說明從第N個點重新規劃 -> 回傳N
2. 如果提到不想去/不喜歡某地點:
- 在行程中找到該地點的step
- 回傳那個step
3. 如果提到不喜歡某時段(早上/下午/晚上):
- 找出該時段第一個景點的step
- 回傳那個step
4. 其他情況 -> 回傳0

必須回傳格式: [數字]
- 一定要包含在中括號內
- 只能有一個整數
- 找不到對應時回傳[0]

範例輸入/輸出:
Input: "從第3個點重來" -> [3]
Input: "不想去星巴克" + 星巴克在step 2 -> [2]
Input: "不要下午行程" + 下午從step 4開始 -> [4]  
Input: "重新規劃" -> [0]
"""

Thinking_A = """
你是個善於分辨形容的旅行助手:
我有用戶的歷史偏好和新輸入,幫我整合規劃建議。
若沒有歷史偏好,請直接依照新輸入來生成。

重要規則:
0. 若用戶沒有輸入文字或無法判斷請直接依格式隨意生成,請不要再詢問用戶
1. 即使用戶沒提到某時段,也要生成該時段的敘述
2. 若用戶沒提供特定時段偏好:
    - 依據其他時段風格延伸合適建議
    - 維持整體行程風格一致性
3. 每個時段一定要有建議,可參考:
    - 用戶喜好的氛圍
    - 是否有提到同伴
    - 整體行程的風格

回傳格式:
[
    {"上午": ""},
    {"中餐": ""},
    {"下午": ""},
    {"晚餐": ""},
    {"晚上": ""}
]
"""

Thinking_B = """
            判斷規則
            1.只有當用戶明確說出某項需求時才設為 true
            2.若沒有提到就為false
            3.這不是在預測用戶可能需要什麼，而是在記錄用戶明確說出的需求
            4.若有提到"停車,收費停車.免費停車都要顯示true
            5.有提到"網路"."無線網路"."免費網路"."wifi"."wi-fi"."WiFi"."Wi-Fi"."Wifi"才需要顯示為true
            6.如果提到餐廳類別,沒有提到內用.洗手間就皆為false
            請根據用戶需求來判斷是否包含該條件，並按照下列格式回傳相應結果。
            除了以下格式，請不要回傳其他任何文字:
            {
                "內用座位": true|false,
                "洗手間": true|false,
                "適合兒童": true|false,
                "適合團體": true|false,
                "現金": true|false,
                "其他支付": true|false,
                "收費停車": true|false,
                "免費停車": true|false,
                "wi-fi": true|false,
                "無障礙": true|false
            }
            """

# Thinking_C "結束時間"判定會出問題,還需要修正
Thinking_C = f"""
請根據用戶需求判斷並提供行程基本資訊。
注意: 今天是{datetime.now(ZoneInfo("Asia/Taipei")).strftime('%Y-%m-%d')}。
當用戶提到相對日期時(例如"下禮拜一")，請根據今天日期計算出正確的MM-DD格式。

例如:
用戶說"下禮拜一"，請根據今天日期計算出正確的日期(MM-DD格式)
如果無法判斷確切日期則回傳"none"

注意事項:
- 用戶提到想去的地點是規劃行程範圍，不是結束地點
- 除非用戶明確說"要在某處結束"，否則結束地點請回傳"none"（表示回到起點）
- 交通方式必須是: 大眾運輸|開車|騎車|步行 其中之一

下列的值都是預設值，未提及的資訊請填入"none"或預設值，請使用以下格式回傳:
{{
    "出發時間": "09:00",
    "結束時間": "21:00",
    "出發地點": "台北車站",
    "結束地點": "none",
    "交通方式": "大眾運輸", # 大眾運輸|開車|騎車|步行 擇一 
    "可接受距離門檻(KM)": 30,
    "早餐時間": "none",
    "中餐時間": "12:00",  # 必須是 hh:mm 格式或 none
    "晚餐時間": "18:00",  # 必須是 hh:mm 格式或 none
    "預算": "none",
    "出發日": "none"  # 必須是 MM-DD 格式或 none
}}
"""

summarize_history = """
請將用戶的歷史對話記錄整理成一段簡短摘要。
請以下列重點整理:
1. 明確的偏好和禁忌,曾經有說過喜歡或不喜歡某些地方需要記錄起來
2. 餐廳和預算要求
3. 明確的時間限制

回傳格式: ["整理後的一段文字"]  # 重要:需要是list格式
範例: ["用戶偏好文青風景點,不想去吵雜的地方,午餐預算500內,希望10點開始行程。"]
"""

Cloud_A = """
            根據用戶需求,生成一句簡短的敘述來形容使用者的喜好,形容客戶喜好的敘述,並使用下列格式輸出:
            [""] 
            """
Cloud_B = """
            判斷規則
            1.只有當用戶明確說出某項需求時才設為 true
            2.若沒有提到就為false
            3.這不是在預測用戶可能需要什麼，而是在記錄用戶明確說出的需求
            4.若有提到"停車,收費停車.免費停車都要顯示true
            5.有提到"網路"."無線網路"."免費網路"."wifi"."wi-fi"."WiFi"."Wi-Fi"."Wifi"才需要顯示為true
            6.如果提到餐廳類別,沒有提到內用.洗手間就皆為false
            請根據用戶需求來判斷是否包含該條件，並按照下列格式回傳相應結果：
            {{
                "內用座位": true|false,
                "洗手間": true|false,
                "適合兒童": true|false,
                "適合團體": true|false,
                "現金": true|false,
                "其他支付": true|false,
                "收費停車": true|false,
                "免費停車": true|false,
                "wi-fi": true|false,
                "無障礙": true|false
            }}
            """
Cloud_C = """
        規則(讓我們一步一步思考)
        1. 請根據用戶需求來判斷並提供以下行程規劃資訊
        2. 星期一到日為1-7,如果超過7，幫我除以7看餘數是多少對應星期
        3. 這不是在預測用戶可能需要什麼，而是在記錄用戶明確說出的需求
        4. 時間格式必須是"hh:mm" 或是 "none"
        5. 關於距離單位的處理：
            - 需要將所有距離單位統一轉換為公里(KM)
            - 公厘=公釐=毫米=mm
            - 轉換對照表：
                * 1公尺(m) = 0.001公里(km)
                * 1公里(km) = 1公里(km)
                * 1英里(mile) = 1.60934公里(km)
            - 轉換後的數值必須是整數，小數部分需四捨五入
            - 如果用戶提到的距離不是有效的距離單位，則設為 "none"
            - 若用戶完全沒有提到距離相關資訊，則設為 "none"
            - 若用戶說"3公里以內" → 可接受距離門檻(KM) = 3
            - 若用戶說"500公尺" → 可接受距離門檻(KM) = 1（四捨五入後）
            - 若用戶說"2英里" → 可接受距離門檻(KM) = 3（四捨五入後）
            - 若用戶說"不要太遠" → 可接受距離門檻(KM) = "none"
        6. 關於出發地點的判斷規則：
            A. 只有當用戶明確提到特定地區時（例如：「淡水」、「信義區」等），才需要返回對應地區的經緯度
            B. 在以下情況必須返回 "none"：
                - 用戶只說「附近」、「這裡」等模糊位置
                - 用戶完全沒有提到位置資訊
                - 用戶提供的是實際定位（這部分會由系統另外處理）
            
            舉例：
            - 用戶說「想吃淡水的拉麵」→ 出發地點: [25.1276, 121.4456]
            - 用戶說「附近有什麼好吃的」→ 出發地點: "none"
            - 用戶說「推薦美食」→ 出發地點: "none"
            特別注意：
            - 不要試圖自行判斷或使用用戶的實際位置
            - 只根據用戶文字中明確提到的地區來決定是否返回經緯度
            - 如有任何不確定，一律返回 "none"
        7. 承6,如果確定用戶輸入的地點在新北與台北的範圍內,使用以下經緯度對照：
        台北市：
           -中正區: [25.0346, 121.5219] 
           -大同區: [25.0576, 121.5101] 
           -中山區: [25.0523, 121.5250] 
           -松山區: [25.0508, 121.5784] 
           -大安區: [25.0330, 121.5293] 
           -萬華區: [25.0360, 121.4970] 
           -信義區: [25.0330, 121.5654] 
           -士林區: [25.1365, 121.5445] 
           -北投區: [25.1372, 121.5065] 
           -內湖區: [25.0835, 121.5890] 
           -南港區: [25.0563, 121.6173] 
           -文山區: [24.9883, 121.5687]

        新北市：
           -板橋區: [25.0141, 121.4639] 
           -三重區: [25.0680, 121.4930] 
           -中和區: [24.9975, 121.4949] 
           -永和區: [25.0086, 121.5146] 
           -新莊區: [25.0369, 121.4326] 
           -新店區: [24.9572, 121.5375] 
           -樹林區: [24.9820, 121.4185] 
           -鶯歌區: [24.9537, 121.3512] 
           -三峽區: [24.9348, 121.3682] 
           -淡水區: [25.1735, 121.4397] 
           -汐止區: [25.0687, 121.6403] 
           -瑞芳區: [25.1095, 121.8062] 
           -土城區: [24.9738, 121.4462] 
           -蘆洲區: [25.0915, 121.4679] 
           -五股區: [25.0953, 121.4312] 
           -泰山區: [25.0598, 121.4295] 
           -林口區: [25.0779, 121.3885] 
           -深坑區: [25.0003, 121.6187] 
           -石碇區: [24.9465, 121.6476] 
           -坪林區: [24.9358, 121.7130] 
           -三芝區: [25.2565, 121.5032] 
           -石門區: [25.2912, 121.5654] 
           -八里區: [25.1523, 121.4059] 
           -平溪區: [25.0255, 121.7388] 
           -雙溪區: [25.0382, 121.8685] 
           -貢寮區: [25.1204, 121.9257] 
           -金山區: [25.2236, 121.6402] 
           -萬里區: [25.1815, 121.6880] 
           -烏來區: [24.8645, 121.5501] 

           
           注意：一定要使用上述提供的準確數值，不要自行生成或計算經緯度。
           
        8. 如果沒有提到某個需求，請設為 "none",並按照下列格式回傳相應結果：
        {{
        "星期別": int | "none",
        "時間": "hh:mm" | "none",
        "類別":  餐廳 | 咖啡廳 | 小吃 | 景點,
        "預算": int | "none",
        "出發地點" : [緯度,經度] | "none",  
        "可接受距離門檻(KM)" : int | "none",
        "交通方式" : "大眾運輸" | "開車" | "騎車" | "步行"
        }}
        """